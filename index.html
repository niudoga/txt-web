<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文本分享 · 零后端版</title>
  <style>
    :root{--p:#5b7fff;--bg:#f8f9fc;--c:#fff;--t:#333;--b:#e1e5ea}
    @media (prefers-color-scheme: dark){
      :root{--bg:#0d1117;--c:#161b22;--t:#c9d1d9;--b:#30363d}
    }
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--t);padding:20px;line-height:1.6}
    .container{max-width:800px;margin:40px auto;background:var(--c);border-radius:16px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,.08);border:1px solid var(--b)}
    h1{text-align:center;margin:0 0 30px;color:var(--p);font-size:1.8em}
    textarea{width:100%;height:300px;padding:16px;border:1px solid var(--b);border-radius:12px;font-size:16px;background:var(--bg);color:var(--t);resize:vertical;box-sizing:border-box}
    button{padding:14px 28px;background:var(--p);color:#fff;border:none;border-radius:12px;font-size:16px;cursor:pointer;margin-top:16px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .progress{height:8px;background:var(--b);border-radius:4px;overflow:hidden;margin:20px 0}
    .bar{height:100%;background:var(--p);width:0%;transition:width .4s}
    .usage{text-align:center;font-size:14px;color:#888;margin-top:8px}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);align-items:center;justify-content:center;z-index:100;padding:20px}
    .modal.show{display:flex}
    .modal-content{background:var(--c);padding:30px;border-radius:16px;max-width:500px;width:100%;border:1px solid var(--b);position:relative}
    .link{background:var(--bg);padding:12px;border-radius:8px;margin:12px 0;font-family:monospace;font-size:14px;border:1px solid var(--b);word-break:break-all}
    .copy{background:var(--p);margin-top:8px;width:100%;padding:10px}
    .close{position:absolute;top:12px;right:16px;font-size:28px;cursor:pointer;opacity:.6}
    @media (max-width:600px){.container{margin:10px;padding:20px}}
  </style>
</head>
<body>
  <div class="container">
    <h1>文本分享（零后端）</h1>
    <textarea id="text" placeholder="粘贴你要分享的文本…"></textarea>
    <button id="save">立刻生成链接</button>

    <div class="progress"><div class="bar" id="bar"></div></div>
    <div class="usage" id="usage">加载使用率…</div>
  </div>

  <!-- 成功弹窗 -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close" onclick="modal.classList.remove('show')">&times;</span>
      <h2>分享成功！</h2>
      <p><strong>直接链接：</strong></p>
      <div class="link" id="direct"></div>
      <button class="copy" onclick="copy(direct.textContent)">复制</button>

      <p style="margin-top:20px"><strong>Base64 外链（给 a.com 用）：</strong></p>
      <div class="link" id="base"></div>
      <button class="copy" onclick="copy(base.textContent)">复制</button>
    </div>
  </div>

  <script>
    // 把你的 Worker 地址改成这里（必须带 https://）
    const API = "https://api-1.niudog.workers.dev";   // ← 改成你自己的 Worker 地址！

    const modal = document.getElementById("modal");
    const direct = document.getElementById("direct");
    const base = document.getElementById("base");
    const bar = document.getElementById("bar");
    const usage = document.getElementById("usage");

    // 加载使用率
    async function loadUsage() {
      try {
        const r = await fetch(API + "/api/status");
        const d = await r.json();
        bar.style.width = d.percent + "%";
        usage.textContent = `存储使用率 ${d.percent}%`;
      } catch { usage.textContent = "使用率获取失败（功能正常）"; }
    }
    loadUsage();
    setInterval(loadUsage, 20000);

    // 存储
    document.getElementById("save").onclick = async () => {
      const text = document.getElementById("text").value.trim();
      if (!text) return alert("请输入内容");
      if (text.length > 490000) return alert("文本太长了");

      const btn = document.getElementById("save");
      btn.disabled = true;
      btn.textContent = "生成中…";

      try {
        const r = await fetch(API + "/api/store", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({text})
        });
        const d = await r.json();
        if (!d.success) throw "";

        const url = d.directUrl;
        direct.textContent = url;
        base.textContent = "https://a.com/?url=" + encodeURIComponent(url);
        modal.classList.add("show");
      } catch {
        alert("生成失败，可能是 Worker 挂了或网络问题");
      }
      btn.disabled = false;
      btn.textContent = "立刻生成链接";
    };

    function copy(t) {
      navigator.clipboard.writeText(t).then(()=>alert("已复制！"));
    }

    modal.addEventListener("click", e => {
      if (e.target === modal) modal.classList.remove("show");
    });
  </script>
</body>
</html>
    <!-- 成功弹窗 -->
    <div id="success-modal" class="modal">
        <div class="modal-content">
            <h3>✅ 存储成功!</h3>
            <p>你的文本已保存</p>
            <div style="margin: 15px 0;">
                <strong>访问链接:</strong><br>
                <input type="text" id="result-url" style="width: 100%; padding: 5px; margin: 5px 0;" readonly>
            </div>
            <div style="margin: 15px 0;">
                <strong>Twitter分享:</strong><br>
                <input type="text" id="result-shorturl" style="width: 100%; padding: 5px; margin: 5px 0;" readonly>
            </div>
            <button onclick="copyUrl()" style="background: #28a745;">复制链接</button>
            <button onclick="closeModal()" style="background: #6c757d;">关闭</button>
        </div>
    </div>

    <script>
        // 配置 - 修改为你的Worker地址
        const BASE_API = 'https://your-worker.your-account.workers.dev';
        
        // 初始化加载状态
        loadStatus();

        // 加载存储状态
        async function loadStatus() {
            try {
                const response = await fetch(`${BASE_API}/api/status`);
                const data = await response.json();
                
                document.getElementById('usage-percent').textContent = data.usage_percent;
                document.getElementById('progress-bar').style.width = data.usage_percent + '%';
                document.getElementById('progress-bar').textContent = data.usage_percent + '%';
                document.getElementById('stored-count').textContent = data.stored_count;
                
                // 根据使用率改变颜色
                const progressBar = document.getElementById('progress-bar');
                if (data.usage_percent > 80) {
                    progressBar.style.background = '#f44336';
                } else if (data.usage_percent > 50) {
                    progressBar.style.background = '#ff9800';
                } else {
                    progressBar.style.background = '#4CAF50';
                }
            } catch (error) {
                console.error('获取状态失败:', error);
            }
        }

        // 存储文本
        async function storeText() {
            const content = document.getElementById('content').value.trim();
            if (!content) {
                alert('请输入文本内容');
                return;
            }

            try {
                const response = await fetch(`${BASE_API}/api/store`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content })
                });

                const result = await response.json();
                
                if (result.success) {
                    // 显示成功弹窗
                    document.getElementById('result-url').value = result.url;
                    document.getElementById('result-shorturl').value = result.shortUrl;
                    document.getElementById('success-modal').style.display = 'block';
                    
                    // 刷新状态
                    loadStatus();
                } else {
                    alert('存储失败: ' + result.error);
                }
            } catch (error) {
                alert('网络错误: ' + error.message);
            }
        }

        // 复制链接
        function copyUrl() {
            const urlInput = document.getElementById('result-url');
            urlInput.select();
            document.execCommand('copy');
            alert('链接已复制到剪贴板!');
        }

        // 关闭弹窗
        function closeModal() {
            document.getElementById('success-modal').style.display = 'none';
            document.getElementById('content').value = ''; // 清空输入框
        }
    </script>
</body>
              </html>
